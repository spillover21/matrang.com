<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .container {
            border: 2px solid #333;
            padding: 20px;
            margin: 20px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        #log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>üîß –¢–µ—Å—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è PDF –ø–æ–ª–µ–π</h1>
    
    <div class="container">
        <h2>–®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∏—Ç—å PDF —à–∞–±–ª–æ–Ω</h2>
        <p>–£–∫–∞–∂–∏—Ç–µ URL –≤–∞—à–µ–≥–æ PDF —à–∞–±–ª–æ–Ω–∞:</p>
        <input type="text" id="pdfUrl" value="/uploads/contracts/contract_template.pdf" style="width: 100%; padding: 10px;">
        <button onclick="loadPDF()">–ó–∞–≥—Ä—É–∑–∏—Ç—å PDF</button>
    </div>

    <div class="container">
        <h2>–®–∞–≥ 2: –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª—è</h2>
        <button onclick="fillPDF()" id="fillBtn" disabled>–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª—è —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</button>
        <button onclick="downloadPDF()" id="downloadBtn" disabled>–°–∫–∞—á–∞—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π PDF</button>
        <button onclick="sendPDF()" id="sendBtn" disabled>üìß –û–¢–ü–†–ê–í–ò–¢–¨ –ù–ê –ü–û–ß–¢–£</button>
    </div>

    <div class="container">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏</h2>
        <label>Email –ø–æ–∫—É–ø–∞—Ç–µ–ª—è:</label>
        <input type="email" id="buyerEmailInput" value="kharynadenis@gmail.com" style="width: 100%; padding: 10px; margin-bottom: 10px;">
        <label>Email –ø–∏—Ç–æ–º–Ω–∏–∫–∞:</label>
        <input type="email" id="kennelEmailInput" value="test@kennel.com" style="width: 100%; padding: 10px;">
    </div>

    <div class="container">
        <h2>–õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
        <div id="log"></div>
    </div>

    <script>
        let pdfDoc = null;
        let filledPdfBytes = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function loadPDF() {
            try {
                const url = document.getElementById('pdfUrl').value;
                log(`üìÑ –ó–∞–≥—Ä—É–∂–∞–µ–º PDF: ${url}`);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                log(`‚úì PDF –∑–∞–≥—Ä—É–∂–µ–Ω, —Ä–∞–∑–º–µ—Ä: ${arrayBuffer.byteLength} –±–∞–π—Ç`);
                
                pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                log(`‚úì PDF —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω —É—Å–ø–µ—à–Ω–æ`);
                
                const form = pdfDoc.getForm();
                const fields = form.getFields();
                
                log(`‚úì –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ–π: ${fields.length}`, 'success');
                
                if (fields.length > 0) {
                    log(`\n–°–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π:`);
                    fields.forEach((field, index) => {
                        const name = field.getName();
                        const type = field.constructor.name;
                        log(`  ${index + 1}. ${name} (${type})`);
                    });
                    document.getElementById('fillBtn').disabled = false;
                } else {
                    log(`‚ö†Ô∏è –í PDF –Ω–µ—Ç AcroForm –ø–æ–ª–µ–π!`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function fillPDF() {
            try {
                log(`\nüîß –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π...`);
                
                const form = pdfDoc.getForm();
                
                // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ - –í–ê–ñ–ù–û: –∏–º–µ–Ω–∞ –ø–æ–ª–µ–π —Å –æ–±—Ä–∞—Ç–Ω—ã–º–∏ –∫–∞–≤—ã—á–∫–∞–º–∏!
                const testData = {
                    '`kennelAddress`': '–¢–µ—Å—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å –ø–∏—Ç–æ–º–Ω–∏–∫–∞ 123',
                    '`kennelPassportSeries`': '1234',
                    '`kennelPassportNumber`': '567890',
                    '`kennelPassportIssuedBy`': '–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ä–≥–∞–Ω',
                    '`kennelPassportIssuedDate`': '01.01.2020',
                    '`kennelPhone`': '+7 900 123 45 67',
                    '`kennelEmail`': 'test@kennel.com',
                    '`kennelOwner`': '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤',
                    
                    '`buyerName`': '–ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤',
                    '`buyerAddress`': '–¢–µ—Å—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å –ø–æ–∫—É–ø–∞—Ç–µ–ª—è 456',
                    '`buyerPassportSeries`': '9876',
                    '`buyerPassportNumber`': '543210',
                    '`buyerPassportIssuedBy`': '–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ä–≥–∞–Ω 2',
                    '`buyerPassportIssuedDate`': '02.02.2021',
                    '`buyerPhone`': '+7 900 987 65 43',
                    '`buyerEmail`': 'buyer@test.com',
                    
                    '`dogName`': '–†–µ–∫—Å',
                    '`dogBirthDate`': '15.05.2023',
                    '`dogColor`': '–ß–µ—Ä–Ω—ã–π',
                    '`dogChipNumber`': '123456789012345',
                    '`dogPuppyCard`': 'PUPPY-2023-001',
                    
                    '`dogFatherName`': '–ß–µ–º–ø–∏–æ–Ω –û—Ç–µ—Ü',
                    '`dogFatherRegNumber`': 'REG-FATHER-001',
                    '`dogMotherName`': '–ß–µ–º–ø–∏–æ–Ω –ú–∞—Ç—å',
                    '`dogMotherRegNumber`': 'REG-MOTHER-001',
                    
                    '`price`': '100000',
                    '`depositAmount`': '30000',
                    '`depositDate`': '01.06.2023',
                    '`remainingAmount`': '70000',
                    '`finalPaymentDate`': '15.06.2023',
                    
                    '`dewormingDate`': '10.05.2023',
                    '`vaccinationDates`': '20.05.2023, 10.06.2023',
                    '`vaccineName`': 'Nobivac DHPPi',
                    '`nextDewormingDate`': '10.07.2023',
                    '`nextVaccinationDate`': '20.07.2023',
                    
                    '`specialFeatures`': '–û—Å–æ–±—ã–µ –ø—Ä–∏–º–µ—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç',
                    '`deliveryTerms`': '–°–∞–º–æ–≤—ã–≤–æ–∑',
                    '`additionalAgreements`': '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è',
                    '`recommendedFood`': 'Royal Canin',
                    
                    '`contractDate`': '01.06.2023',
                    '`contractPlace`': '–≥. –ú–æ—Å–∫–≤–∞',
                    '`contractNumber`': 'DOG-2023-TEST-001'
                };
                
                let filledCount = 0;
                let notFoundCount = 0;
                
                for (const [fieldName, value] of Object.entries(testData)) {
                    try {
                        // –ü—Ä–æ–±—É–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
                        if (typeof value === 'boolean') {
                            const checkbox = form.getCheckBox(fieldName);
                            if (value) checkbox.check();
                            else checkbox.uncheck();
                            log(`  ‚úì ${fieldName} = ${value}`);
                            filledCount++;
                        } else {
                            const textField = form.getTextField(fieldName);
                            textField.setText(String(value));
                            log(`  ‚úì ${fieldName} = ${value}`);
                            filledCount++;
                        }
                    } catch (e) {
                        log(`  ‚úó ${fieldName} - –ø–æ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`, 'error');
                        notFoundCount++;
                    }
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —á–µ–∫–±–æ–∫—Å—ã
                try {
                    const purposeBreeding = form.getCheckBox('`purposeBreeding`');
                    purposeBreeding.check();
                    log(`  ‚úì purposeBreeding = checked`);
                    filledCount++;
                } catch (e) {}
                
                log(`\n‚úÖ –ó–ê–ü–û–õ–ù–ï–ù–û: ${filledCount} –ø–æ–ª–µ–π`, 'success');
                log(`‚ùå –ù–ï –ù–ê–ô–î–ï–ù–û: ${notFoundCount} –ø–æ–ª–µ–π`, notFoundCount > 0 ? 'error' : 'info');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π PDF –ë–ï–ó –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞
                // –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π
                filledPdfBytes = await pdfDoc.save({ updateFieldAppearances: false });
                log(`\nüíæ PDF —Å–æ—Ö—Ä–∞–Ω–µ–Ω, —Ä–∞–∑–º–µ—Ä: ${filledPdfBytes.length} –±–∞–π—Ç`, 'success');
                
                document.getElementById('downloadBtn').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                
            } catch (error) {
                log(`‚ùå –û–®–ò–ë–ö–ê –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function downloadPDF() {
            if (!filledPdfBytes) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ PDF!');
                return;
            }
            
            const blob = new Blob([filledPdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'filled_contract.pdf';
            a.click();
            URL.revokeObjectURL(url);
            
            log(`üì• PDF —Å–∫–∞—á–∞–Ω`, 'success');
        }

        async function sendPDF() {
            if (!filledPdfBytes) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ PDF!');
                return;
            }

            try {
                log(`\nüìß –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ email...`);
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64 –ß–ê–°–¢–Ø–ú–ò (–±–æ–ª—å—à–æ–π —Ñ–∞–π–ª)
                log(`‚úì –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º PDF –≤ base64...`);
                let binary = '';
                const chunkSize = 0x8000; // 32KB chunks
                for (let i = 0; i < filledPdfBytes.length; i += chunkSize) {
                    binary += String.fromCharCode(...filledPdfBytes.subarray(i, i + chunkSize));
                }
                const base64 = btoa(binary);
                log(`‚úì PDF –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ base64: ${base64.length} —Å–∏–º–≤–æ–ª–æ–≤`);

                const buyerEmail = document.getElementById('buyerEmailInput').value;
                const kennelEmail = document.getElementById('kennelEmailInput').value;

                const payload = {
                    data: {
                        buyerEmail: buyerEmail,
                        kennelEmail: kennelEmail,
                        buyerName: '–ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤',
                        dogName: '–†–µ–∫—Å',
                        contractNumber: 'DOG-2023-TEST-001'
                    },
                    pdfTemplate: '/uploads/contracts/contract_template.pdf',
                    filledPdfBase64: base64
                };

                log(`‚úì –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ /api/api.php?action=sendcontractpdf`);
                
                const response = await fetch('/api/api.php?action=sendcontractpdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const responseText = await response.text();
                log(`‚úì –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç (${response.status}): ${responseText.substring(0, 500)}...`);

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    log(`‚ùå –û—Ç–≤–µ—Ç –Ω–µ JSON! –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç:\n${responseText}`, 'error');
                    throw new Error('Server returned non-JSON response: ' + responseText.substring(0, 200));
                }
                
                if (result.success) {
                    log(`\n‚úÖ –£–°–ü–ï–•! Email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ${buyerEmail}`, 'success');
                    alert('‚úÖ –î–æ–≥–æ–≤–æ—Ä —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email!');
                } else {
                    log(`\n‚ùå –û–®–ò–ë–ö–ê: ${result.message}`, 'error');
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + result.message);
                }

            } catch (error) {
                log(`\n‚ùå –û–®–ò–ë–ö–ê –û–¢–ü–†–ê–í–ö–ò: ${error.message}`, 'error');
                console.error(error);
                alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
            }
        }
    </script>
</body>
</html>
