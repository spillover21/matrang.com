<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico?v=2" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MATRANG DOGS</title>
    <meta name="description" content="–ø–∏—Ç–æ–º–Ω–∏–∫ –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏—Ö –±—É–ª–ª–∏ Great Legacy bully" />
    <meta name="author" content="MATRANG Kennel" />

    <meta property="og:title" content="MATRANG" />
    <meta property="og:description" content="–ø–∏—Ç–æ–º–Ω–∏–∫ –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏—Ö –±—É–ª–ª–∏ Great Legacy bully" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://matrang.com/" />
    <meta property="og:image" content="https://matrang.com/uploads/1767891439_85337ea8.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@MATRANG" />
    <meta name="twitter:image" content="/assets/hero-pitbull.jpg" />
    
    <script>
      // DEBUG: –ü–µ—Ä–µ—Ö–≤–∞—Ç –∫–ª–∏–∫–æ–≤ –Ω–∞ –≤—Å–µ—Ö –∫–Ω–æ–ø–∫–∞—Ö
      window.addEventListener('DOMContentLoaded', function() {
        console.error('üü¢ DEBUG SCRIPT LOADED at ' + new Date().toISOString());
        
        setInterval(function() {
          const sendButton = Array.from(document.querySelectorAll('button')).find(btn => 
            btn.textContent && (btn.textContent.includes('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ email') || btn.textContent.includes('–û—Ç–ø—Ä–∞–≤–∫–∞'))
          );
          
          if (sendButton && !sendButton.dataset.debugAttached) {
            sendButton.dataset.debugAttached = 'true';
            console.error('üîµ Found send button, attaching debug listener');
            
            sendButton.addEventListener('click', function(e) {
              console.error('üî¥üî¥üî¥ BUTTON CLICKED!', e);
              alert('üî¥ BUTTON CLICKED! Time: ' + Date.now());
              window.__BUTTON_CLICKED = Date.now();
            }, true); // capture phase
          }
        }, 1000);
      });
    </script>




    <script type="module" crossorigin src="/assets/index-sKnweAqN-1769466368072.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-D35cW1RB.css">
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  </head>

  <body>
    <div id="root"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
      #vanilla-contract-ui input, #vanilla-contract-ui button { transition: all 0.2s; }
      #vanilla-contract-ui button:active { transform: scale(0.95); }
    </style>
  </head>

  <body>
    <div id="root"></div>
    
    <!-- VANILLA JS BRIDGE - SCRAPES REACT DOM AND FILLS PDF -->
    <div id="vanilla-contract-ui" style="position: fixed; top: 80px; right: 20px; z-index: 9999; background: #fffbeb; border: 3px solid #d97706; padding: 20px; border-radius: 12px; max-width: 350px; box-shadow: 0 20px 50px rgba(0,0,0,0.4); font-family: sans-serif;">
      <h2 style="margin: 0 0 10px 0; color: #92400e; font-size: 16px; font-weight: 800; text-transform: uppercase;">‚ö° PDF –ö–û–ù–°–¢–†–£–ö–¢–û–†</h2>
      
      <div id="vanilla-pdf-status" style="margin-bottom: 10px; font-size: 12px; padding: 5px; background: #fef3c7; border-radius: 4px; border: 1px solid #fcd34d;">
        ‚è≥ –ü–æ–∏—Å–∫ —à–∞–±–ª–æ–Ω–∞...
      </div>
      
      <button id="vanilla-fill-btn" style="width: 100%; padding: 14px; margin-bottom: 8px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px;">
        1. üîß –ó–ê–ü–û–õ–ù–ò–¢–¨ –ò–ó –§–û–†–ú–´
      </button>
      
      <button id="vanilla-download-btn" style="width: 100%; padding: 14px; margin-bottom: 8px; background: #059669; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px;">
        2. üíæ –°–ö–ê–ß–ê–¢–¨ –ò –ü–†–û–í–ï–†–ò–¢–¨
      </button>
      
      <button id="vanilla-send-btn" style="width: 100%; padding: 14px; background: #dc2626; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px;">
        3. üìß –û–¢–ü–†–ê–í–ò–¢–¨ –ö–õ–ò–ï–ù–¢–£
      </button>

      <div style="margin-top: 10px;">
        <label style="font-size:10px; color:#92400e; font-weight:bold;">–ò–õ–ò –ó–ê–ì–†–£–ó–ò–¢–ï –°–í–û–ô PDF:</label>
        <input type="file" id="manual-pdf-input" accept=".pdf" style="font-size:10px; width:100%">
      </div>
      
      <p id="vanilla-status" style="margin: 10px 0 0 0; font-size: 11px; color: #78350f; font-weight: bold; min-height: 1.2em;">...</p>
    </div>
    
    <script>
    (function() {
      const { PDFDocument } = PDFLib;
      let filledPdfBytes = null;
      let pdfTemplatePath = null;
      
      const statusEl = document.getElementById('vanilla-status');
      const setStatus = (msg) => { statusEl.textContent = msg; console.log('[VANILLA]', msg); };
      
      const getValByPlaceholder = (ph) => {
        const el = document.querySelector(`input[placeholder="${ph}"]`);
        return el ? el.value : '';
      };
      
      const getHeaders = () => {
        const token = localStorage.getItem("admin_token");
        return token ? { 'Authorization': `Bearer ${token}` } : {};
      };
      
      async function checkPdfTemplate() {
        try {
          const headers = getHeaders();
          if (!headers.Authorization) {
            const statusDiv = document.getElementById('vanilla-pdf-status');
            statusDiv.innerHTML = 'üîí <b>–í–æ–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω–∫—É</b>';
            statusDiv.style.background = '#f3f4f6';
            return;
          }
          
          const res = await fetch('/api/api.php?action=getContracts', { headers });
          const data = await res.json();
          const statusDiv = document.getElementById('vanilla-pdf-status');
          
          if (data.success && data.pdfTemplate) {
            pdfTemplatePath = data.pdfTemplate;
            statusDiv.innerHTML = '‚úÖ <b>–®–∞–±–ª–æ–Ω –Ω–∞–π–¥–µ–Ω!</b><br>–ú–æ–∂–Ω–æ –∑–∞–ø–æ–ª–Ω—è—Ç—å.';
            statusDiv.style.background = '#d1fae5';
            statusDiv.style.borderColor = '#34d399';
          } else {
            statusDiv.innerHTML = '‚ö†Ô∏è <b>–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.</b><br>–ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF –≤ –∞–¥–º–∏–Ω–∫–µ.';
            statusDiv.style.background = '#fee2e2';
            statusDiv.style.borderColor = '#f87171';
          }
        } catch (e) { console.error(e); }
      }
      setInterval(checkPdfTemplate, 3000);
      checkPdfTemplate();

      document.getElementById('vanilla-fill-btn').addEventListener('click', async () => {
        if (!pdfTemplatePath) { alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ PDF —à–∞–±–ª–æ–Ω –≤ –∞–¥–º–∏–Ω–∫–µ (—Å–ª–µ–≤–∞)!'); return; }
        
        try {
          setStatus('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ...');
          
          const data = {
            kennelName: getValByPlaceholder('GREAT LEGACY BULLY'),
            kennelOwner: getValByPlaceholder('–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á'),
            kennelAddress: getValByPlaceholder('–≥. –ö–∞—è–∞–Ω–∏, –§–∏–Ω–ª—è–Ω–¥–∏—è'),
            kennelPhone: getValByPlaceholder('+7 (900) 455-27-16'),
            kennelEmail: getValByPlaceholder('greatlegacybully@gmail.com'),
            
            buyerName: getValByPlaceholder('–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á'),
            buyerAddress: getValByPlaceholder('–≥. –ú–æ—Å–∫–≤–∞, —É–ª. ...'),
            buyerPhone: getValByPlaceholder('+7 (___) ___-__-__'),
            buyerEmail: getValByPlaceholder('buyer@email.com'),
            
            dogName: getValByPlaceholder('MATRANG'),
            dogBreed: getValByPlaceholder('–ê–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–π –±—É–ª–ª–∏'),
            dogColor: getValByPlaceholder('Blue Fawn'),
            dogPrice: getValByPlaceholder('150000'),
            
            contractDate: new Date().toLocaleDateString('ru-RU')
          };
          
          console.log('[VANILLA] Scraped Data:', data);
          if(!data.buyerEmail) { alert('‚ö†Ô∏è Email –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ.'); }

          const pdfBytes = await fetch(pdfTemplatePath).then(res => res.arrayBuffer());
          const pdfDoc = await PDFDocument.load(pdfBytes);
          const form = pdfDoc.getForm();
          
          const fieldMap = {
            '`kennelName`': data.kennelName,
            '`kennelOwner`': data.kennelOwner,
            '`kennelAddress`': data.kennelAddress,
            '`kennelPhone`': data.kennelPhone,
            '`kennelEmail`': data.kennelEmail,
            '`buyerName`': data.buyerName,
            '`buyerAddress`': data.buyerAddress,
            '`buyerPhone`': data.buyerPhone,
            '`buyerEmail`': data.buyerEmail,
            '`dogName`': data.dogName,
            '`dogBreed`': data.dogBreed,
            '`dogColor`': data.dogColor,
            '`totalPrice`': data.dogPrice,
            '`contractDate`': data.contractDate,
            '`contractPlace`': '–≥. –ú–æ—Å–∫–≤–∞'
          };

          let filledCount = 0;
          for (const [name, val] of Object.entries(fieldMap)) {
            try {
              form.getTextField(name).setText(String(val || ''));
              filledCount++;
            } catch (e) {
               try {
                 const cleanName = name.replace(/`/g, '');
                 form.getTextField(cleanName).setText(String(val || ''));
                 filledCount++;
               } catch (e2) {}
            }
          }

          // Force NeedAppearances - ABSOLUTELY CRITICAL
          try {
             const acroForm = pdfDoc.catalog.lookup(PDFLib.PDFName.of('AcroForm'));
             if (acroForm) {
                acroForm.set(PDFLib.PDFName.of('NeedAppearances'), PDFLib.PDFBool.True);
                console.log('[DEBUG] NeedAppearances set to TRUE');
             }
          } catch(e) { console.error('[DEBUG] NeedAppearances error:', e); }

          // Validate filled PDF bytes
          filledPdfBytes = await pdfDoc.save({ updateFieldAppearances: false });
          console.log('[DEBUG] PDF saved, bytes:', filledPdfBytes.byteLength);
          
          setStatus(`‚úÖ –ó–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–µ–π: ${filledCount}`);
          alert(`‚úÖ –£—Å–ø–µ—à–Ω–æ! –ó–∞–ø–æ–ª–Ω–µ–Ω–æ ${filledCount} –ø–æ–ª–µ–π.\n–ù–∞–∂–º–∏—Ç–µ "–°–∫–∞—á–∞—Ç—å" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.`);
          
        } catch (err) {
          setStatus('‚ùå –û—à–∏–±–∫–∞: ' + err.message);
          alert('–û—à–∏–±–∫–∞: ' + err.message);
        }
      });
      
      document.getElementById('vanilla-download-btn').addEventListener('click', () => {
        if (!filledPdfBytes) { alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–ø–æ–ª–Ω–∏—Ç—å"!'); return; }
        const blob = new Blob([filledPdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `contract_${Date.now()}.pdf`;
        a.click();
      });
      
      document.getElementById('vanilla-send-btn').addEventListener('click', async () => {
        if (!filledPdfBytes) { alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–ø–æ–ª–Ω–∏—Ç—å"!'); return; }
        
        const email = getValByPlaceholder('buyer@email.com');
        if (!email) { alert('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω Email –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –≤ —Ñ–æ—Ä–º–µ!'); return; }
        
        if(!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä –Ω–∞ ${email}?`)) return;
        
        try {
          setStatus('‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...');
          const blob = new Blob([filledPdfBytes], { type: 'application/pdf' });
          const fd = new FormData();
          fd.append('file', blob, 'contract.pdf');
          
          const headers = getHeaders();
          const upRes = await fetch('/api/api.php?action=uploadcontract', { method: 'POST', body: fd, headers });
          const upData = await upRes.json();
          
          if (!upData.success) throw new Error(upData.message);
          
          const emailRes = await fetch('/api/api.php?action=sendContractPdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...headers },
            body: JSON.stringify({
              data: { buyerEmail: email }, 
              pdfTemplate: upData.path,
              useUploadedPdf: true
            })
          });
          
          const emailData = await emailRes.json();
          if (emailData.success) {
            setStatus(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!`);
            alert(`‚úÖ –î–æ–≥–æ–≤–æ—Ä —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ${email}`);
          } else {
            throw new Error(emailData.message);
          }
        } catch (err) {
          setStatus('‚ùå ' + err.message);
          alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + err.message);
        }
      });
    })();
    </script>
  </body>
</html>
  </body>
</html>
