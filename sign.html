<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞ | MATRANG</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #f3f4f6; font-family: sans-serif; }
        .container { max-width: 800px; margin: 0 auto; background: white; min-height: 100vh; display: flex; flex-direction: column; }
        
        header { background: #111; color: white; padding: 15px; text-align: center; }
        header h1 { margin: 0; font-size: 18px; }

        #pdf-viewer { flex: 1; overflow-y: auto; background: #525659; padding: 10px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        canvas.pdf-page { max-width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        #controls { padding: 20px; text-align: center; border-top: 1px solid #ddd; background: white; position: sticky; bottom: 0; }
        
        button.primary { background: #2563eb; color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; }
        button.secondary { background: #e5e7eb; color: #111; padding: 10px 20px; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; }

        /* Modal */
        #sign-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        #pad-container { background: white; padding: 10px; border-radius: 10px; width: 95%; max-width: 500px; }
        #pad-canvas { border: 2px dashed #ccc; width: 100%; height: 250px; cursor: crosshair; touch-action: none; background: #fff; }
        .modal-footer { margin-top: 15px; display: flex; gap: 10px; }
        .modal-footer button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-clear { background: #fee2e2; color: #991b1b; }
        .btn-confirm { background: #16a34a; color: white; }

        .loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:2000; align-items:center; justify-content:center; flex-direction:column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üìÑ –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</h1>
    </header>

    <div id="pdf-viewer">
        <!-- PDF Pages will be rendered here -->
        <div style="color:white; margin-top: 50px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞...</div>
    </div>

    <div id="controls">
        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å —Ç–µ–∫—Å—Ç–æ–º –¥–æ–≥–æ–≤–æ—Ä–∞ –ø–µ—Ä–µ–¥ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ–º.</p>
        <button class="primary" onclick="openSignModal()">‚úçÔ∏è –ü–û–î–ü–ò–°–ê–¢–¨ –≠–õ–ï–ö–¢–†–û–ù–ù–û</button>
    </div>
</div>

<!-- Signature Modal -->
<div id="sign-modal">
    <div id="pad-container">
        <h3 style="margin-top:0; text-align:center;">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–æ–¥–ø–∏—Å–∏</h3>
        <p style="font-size:12px; color:#555; text-align:center;">–†–∞—Å–ø–∏—à–∏—Ç–µ—Å—å –ø–∞–ª—å—Ü–µ–º –∏–ª–∏ –º—ã—à–∫–æ–π –≤ –ø–æ–ª–µ –Ω–∏–∂–µ:</p>
        <canvas id="pad-canvas"></canvas>
        <div class="modal-footer">
            <button class="btn-clear" onclick="signaturePad.clear()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <button class="btn-confirm" onclick="finishSigning()">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
        <button onclick="closeSignModal()" style="width:100%; margin-top:10px; background:transparent; border:none; color:#666;">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<div class="loader" id="loader">
    <div class="spinner"></div>
    <p style="margin-top:20px; font-weight:bold;">–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞...</p>
</div>

<script>
    // Config
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    
    // State
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    let originalPdfBytes = null;
    let signaturePad = null;
    
    // Init Signature Pad
    const canvas = document.getElementById('pad-canvas');
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
    }
    window.onresize = resizeCanvas;
    signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });

    // 1. Load PDF
    async function loadPdf() {
        if (!token) return alert('–û—à–∏–±–∫–∞: –°—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ (–Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞)');
        
        try {
            const res = await fetch(`/api/api.php?action=get_signing_pdf&token=${token}`);
            if (!res.ok) throw new Error('Document not found');
            
            originalPdfBytes = await res.arrayBuffer();
            renderPdf(originalPdfBytes);
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message);
        }
    }

    // 2. Render PDF (ReadOnly)
    async function renderPdf(data) {
        const pdf = await pdfjsLib.getDocument(data).promise;
        const viewer = document.getElementById('pdf-viewer');
        viewer.innerHTML = '';

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const scale = 1.5;
            const viewport = page.getViewport({ scale });
            
            const canvas = document.createElement('canvas');
            canvas.className = 'pdf-page';
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
            viewer.appendChild(canvas);
        }
    }

    // Modal Controls
    function openSignModal() {
        document.getElementById('sign-modal').style.display = 'flex';
        resizeCanvas();
    }
    function closeSignModal() {
        document.getElementById('sign-modal').style.display = 'none';
        signaturePad.clear();
    }

    // 3. Apply Signature & Save
    async function finishSigning() {
        if (signaturePad.isEmpty()) return alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –ø–æ–¥–ø–∏—Å—å.');
        
        showLoader(true);
        try {
            // Get Metadata for history
            const metaRes = await fetch(`/api/api.php?action=get_contract_meta&token=${token}`);
            const metaJson = await metaRes.json();
            const history = metaJson.success ? metaJson.meta.history : [];
            const signerEmail = metaJson.success ? metaJson.meta.email : 'Unknown';

            // Add "Signed" event locally for rendering
            const now = new Date();
            history.push({
                event: 'signed',
                time: now.toISOString(),
                desc: `–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–ø–∏—Å–∞–Ω —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é (${signerEmail})`,
                ip: 'Client IP'
            });

            // Prepare signature
            const pngDataUrl = signaturePad.toDataURL();
            const pngImageBytes = await fetch(pngDataUrl).then(res => res.arrayBuffer());

            // Modify PDF
            const { PDFDocument, rgb, StandardFonts } = PDFLib;
            const pdfDoc = await PDFDocument.load(originalPdfBytes);
            const pngImage = await pdfDoc.embedPng(pngImageBytes);
            const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
            
            // 1. SIGN ON LAST PAGE
            const pages = pdfDoc.getPages();
            const lastPage = pages[pages.length - 1];
            const { width, height } = lastPage.getSize();
            
            lastPage.drawImage(pngImage, {
                x: width / 2 + 20,
                y: 100,
                width: 140,
                height: 70,
            });
            lastPage.drawText(`Digital ID: ${token.substring(0,8)}...`, {
                x: width / 2 + 20,
                y: 85,
                size: 7,
                font: font,
                color: rgb(0.5, 0.5, 0.5)
            });

            // 2. CREATE AUDIT REPORT PAGE
            const auditPage = pdfDoc.addPage([595, 842]); // A4
            const apWidth = auditPage.getWidth();
            const apHeight = auditPage.getHeight();
            let yPos = apHeight - 50;

            // Header
            auditPage.drawText('FINAL AUDIT REPORT', { x: 50, y: yPos, size: 24, font: fontBold, color: rgb(0.1, 0.5, 0.9) });
            yPos -= 30;
            auditPage.drawLine({ start: { x: 50, y: yPos }, end: { x: apWidth - 50, y: yPos }, thickness: 2, color: rgb(0, 0, 0) });
            yPos -= 20;

            // Transaction Info Box
            const infoBoxY = yPos;
            auditPage.drawRectangle({ x: 50, y: infoBoxY - 70, width: apWidth - 100, height: 80, borderColor: rgb(0,0,0), borderWidth: 1, color: rgb(0.95, 0.95, 0.95) });
            
            const drawLabelVal = (lbl, val, x, y) => {
                auditPage.drawText(lbl, { x, y, size: 10, font: fontBold });
                auditPage.drawText(val, { x: x + 80, y, size: 10, font: font });
            };

            drawLabelVal('Transaction ID:', token, 60, infoBoxY - 20);
            drawLabelVal('Created:', history[0]?.time.split('T')[0] || '-', 60, infoBoxY - 40);
            drawLabelVal('Status:', 'SIGNED', 60, infoBoxY - 60);
            drawLabelVal('Signer:', signerEmail, 300, infoBoxY - 20);
            
            yPos -= 120;

            // Audit History List
            auditPage.drawText('History', { x: 50, y: yPos, size: 18, font: fontBold });
            yPos -= 20;

            for (const h of history) {
                // Ensure enough space
                if (yPos < 50) { auditPage.addPage(); yPos = 800; }

                const dateStr = h.time.replace('T', ' ').substring(0, 19);
                
                // Icon simulation (circle color based on event)
                let iconColor = rgb(0.5, 0.5, 0.5);
                if (h.event === 'created') iconColor = rgb(0.9, 0.6, 0.1); 
                if (h.event === 'viewed') iconColor = rgb(0.1, 0.6, 0.9);
                if (h.event === 'signed') iconColor = rgb(0.1, 0.8, 0.3);

                auditPage.drawCircle({ x: 60, y: yPos, size: 4, color: iconColor });
                
                // Text
                auditPage.drawText(dateStr + ' GMT', { x: 80, y: yPos + 3, size: 9, font: fontBold, color: rgb(0.3, 0.3, 0.3) });
                auditPage.drawText(h.desc, { x: 80, y: yPos - 10, size: 10, font: font });
                
                if (h.ip) {
                   auditPage.drawText(`IP: ${h.ip}`, { x: 80, y: yPos - 20, size: 8, font: font, color: rgb(0.6, 0.6, 0.6) });
                   yPos -= 40;
                } else {
                   yPos -= 30;
                }
            }
            
            // Bottom validation text
            auditPage.drawText('This audit trail is a binding part of the document transaction.', {
               x: 50, y: 30, size: 8, font: font, color: rgb(0.7,0.7,0.7) 
            });

            const pdfBytes = await pdfDoc.save();
            const base64Pdf = await pdfDoc.saveAsBase64({ dataUri: true });
            
            // Upload
            const res = await fetch('/api/api.php?action=save_signed_pdf', {
                method: 'POST',
                body: JSON.stringify({
                    token: token,
                    pdfBase64: base64Pdf
                })
            });
            
            const json = await res.json();
            if (json.success) {
                alert('‚úÖ –î–æ–≥–æ–≤–æ—Ä —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–Ω! –°–ø–∞—Å–∏–±–æ.');
                window.location.reload(); // Or show success screen
                document.body.innerHTML = '<div style="text-align:center; padding:50px; font-family:sans-serif;"><h1>‚úÖ –ì–æ—Ç–æ–≤–æ!</h1><p>–î–æ–≥–æ–≤–æ—Ä –ø–æ–¥–ø–∏—Å–∞–Ω. –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∫–æ–ø–∏—é –≤–∞–º –Ω–∞ –ø–æ—á—Ç—É.</p></div>';
            } else {
                throw new Error(json.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }

        } catch (e) {
            console.error(e);
            alert('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è: ' + e.message);
        } finally {
            showLoader(false);
            closeSignModal();
        }
    }

    function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }

    // Start
    loadPdf();
</script>

</body>
</html>