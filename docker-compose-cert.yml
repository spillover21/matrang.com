version: '3.8'

services:
  documenso:
    image: documenso-custom
    pull_policy: never
    container_name: documenso
    ports:
      - "9000:3000"
    environment:
      - NODE_ENV=production
      - NEXTAUTH_URL=http://72.62.114.139:9000
      - NEXTAUTH_URL_INTERNAL=http://127.0.0.1:3000
      - NEXT_PRIVATE_INTERNAL_WEBAPP_URL=http://127.0.0.1:3000
      - NEXT_PUBLIC_WEBAPP_URL=http://72.62.114.139:9000
      - NEXT_PRIVATE_SIGNING_LOCAL_FILE_PATH=/app/signing.p12
      - NEXT_PRIVATE_SIGNING_PASSPHRASE=
      - NEXTAUTH_SECRET=8bf8cc24b5ddf56926f0a0986aac8fff4c8b8eddb932acb40e1f4f8a5e55e299
      - NEXT_PRIVATE_ENCRYPTION_KEY=TbeK+aTXwELF+pZ0YUp2N8H3+0m9I5pZM35WOn96caM=
      - NEXT_PRIVATE_ENCRYPTION_SECONDARY_KEY=2vaLkYwC7TWUJj6H4uP1/8QLQv3QIow4vp2j1LYdh98=
      # Database
      - NEXT_PRIVATE_DATABASE_URL=postgresql://documenso:documenso123@postgres:5432/documenso?schema=public
      - NEXT_PRIVATE_DIRECT_DATABASE_URL=postgresql://documenso:documenso123@postgres:5432/documenso?schema=public
      # SMTP Settings (Legacy)
      - SMTP_HOST=smtp.hostinger.com
      - SMTP_PORT=587
      - SMTP_USER=noreply@matrang.com
      - SMTP_PASSWORD=Gibson2104)))
      - SMTP_FROM_NAME="Great Legacy Bully"
      - SMTP_FROM_ADDRESS=noreply@matrang.com

      # SMTP Settings (New - Required by V2)
      - NEXT_PRIVATE_SMTP_HOST=smtp.hostinger.com
      - NEXT_PRIVATE_SMTP_PORT=587
      - NEXT_PRIVATE_SMTP_USERNAME=noreply@matrang.com
      - NEXT_PRIVATE_SMTP_PASSWORD=Gibson2104)))
      - NEXT_PRIVATE_SMTP_SECURE=false
      - NEXT_PRIVATE_SMTP_TRANSPORT=smtp-auth
      - NEXT_PRIVATE_SMTP_SERVICE=
      - NEXT_PRIVATE_SMTP_FROM_ADDRESS=noreply@matrang.com
      - NEXT_PRIVATE_SMTP_FROM_NAME=Matrang

      # Storage
      - NEXT_PRIVATE_STORAGE_TRANSPORT=s3
      - NEXT_PRIVATE_STORAGE_ENDPOINT=http://minio:9000
      - NEXT_PRIVATE_STORAGE_FORCE_PATH_STYLE=true
      - NEXT_PRIVATE_STORAGE_REGION=us-east-1
      - NEXT_PRIVATE_STORAGE_BUCKET=documenso
      - NEXT_PRIVATE_STORAGE_ACCESS_KEY_ID=minioadmin
      - NEXT_PRIVATE_STORAGE_SECRET_ACCESS_KEY=minioadmin123
      - NEXT_PRIVATE_UPLOAD_TRANSPORT=s3
      - NEXT_PUBLIC_UPLOAD_TRANSPORT=s3
      - NEXT_PRIVATE_UPLOAD_ENDPOINT=http://minio:9000
      - NEXT_PRIVATE_UPLOAD_FORCE_PATH_STYLE=true
      - NEXT_PRIVATE_UPLOAD_REGION=us-east-1
      - NEXT_PRIVATE_UPLOAD_BUCKET=documenso
      - NEXT_PRIVATE_UPLOAD_ACCESS_KEY_ID=minioadmin
      - NEXT_PRIVATE_UPLOAD_SECRET_ACCESS_KEY=minioadmin123
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_started
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - documenso-network
    volumes:
      - /root/signing.p12:/app/signing.p12

  postgres:
    image: postgres:15-alpine
    container_name: documenso-postgres
    environment:
      - POSTGRES_USER=documenso
      - POSTGRES_PASSWORD=documenso123
      - POSTGRES_DB=documenso
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U documenso"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - documenso-network

  minio:
    image: minio/minio:latest
    container_name: documenso-minio
    ports:
      - "9001:9001"
      - "9002:9000"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin123
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9001/minio/health/live"]    
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped
    networks:
      - documenso-network

networks:
  documenso-network:
    driver: bridge

volumes:
  postgres_data:
  minio_data:
