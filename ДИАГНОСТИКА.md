# Диагностика проблем с загрузкой PDF и отправкой email

## Шаг 1: Проверить систему

Откройте в браузере: **https://matrang.com/api/test.php**

Эта страница покажет:
- ✅ Версию PHP
- ✅ Все необходимые папки созданы и доступны для записи
- ✅ PDF шаблон загружен (если есть)
- ✅ Библиотеки FPDI установлены
- ✅ Шрифт для русского текста
- ✅ Логи (если есть)

### Что проверить:

1. **Папки** - все должны быть зелеными "OK (writable)"
2. **PDF Шаблон** - если показывает "НЕ НАЙДЕН", значит загрузка не сработала
3. **FPDI** - должна быть "Установлена"
4. **Шрифт** - должен быть "OK"

## Шаг 2: Проверить загрузку PDF

1. В админке нажмите "Выбрать PDF" и загрузите свой договор
2. Откройте браузер консоль (F12 → Console)
3. Посмотрите ответ от сервера - там будет debug информация
4. На странице test.php обновите страницу - теперь должен показать "PDF Шаблон: Найден"

### Если загрузка не работает:

Откройте лог: **data/upload_debug.log** (на test.php есть кнопка "Показать")

Лог покажет:
- Получен ли файл от браузера
- Какой размер файла
- Есть ли ошибки загрузки
- Куда сохранился файл

## Шаг 3: Проверить отправку email

1. Заполните все поля договора
2. **ОБЯЗАТЕЛЬНО** укажите Email покупателя
3. Нажмите "Отправить на email"
4. Откройте логи на test.php:
   - **sendcontract_debug.log** - детальный лог процесса
   - **mail.log** - результат отправки email

### Что смотреть в логах:

**sendcontract_debug.log** покажет:
```
=== SEND CONTRACT === 2026-01-25 15:30:00
JSON input keys: data, pdfTemplate
Generated contract number: DOG-2026-0001
PDF template: /uploads/contracts/contract_template.pdf
Buyer email: test@example.com
Template exists, generating PDF...
PDF generated: YES
PDF file size: 125648 bytes
Mail sent to buyer: SUCCESS
Mail sent to seller: SUCCESS
```

Если где-то ошибка - будет написано ERROR или FAILED.

**mail.log** покажет:
```
2026-01-25 15:30:05 - Email to: test@example.com | PDF: YES | Sent: YES
```

## Шаг 4: Проверить что почта работает

На test.php внизу есть форма "Тест Email":
1. Введите свой email
2. Нажмите "Отправить тестовое письмо"
3. Проверьте почту (и папку СПАМ!)

Если тестовое письмо НЕ пришло - проблема в настройках сервера (нужно настроить SMTP).

## Возможные проблемы и решения

### 1. PDF не загружается
**Симптомы:** test.php показывает "PDF Шаблон: НЕ НАЙДЕН"

**Решение:**
- Проверьте права на папку uploads/contracts
- Посмотрите upload_debug.log - там будет причина

### 2. PDF генерируется но пустой
**Симптомы:** sendcontract_debug.log пишет "PDF generated: YES" но в файле пусто

**Решение:**
- Откройте api/generate_contract_pdf.php
- Проблема в координатах - нужно их настроить под ваш шаблон

### 3. Email не отправляется
**Симптомы:** mail.log пишет "Sent: NO"

**Решение:**
- Проверьте тестовую отправку на test.php
- Если тестовое не работает - нужно настроить SMTP на сервере
- Если тестовое работает, а договор нет - проверьте sendcontract_debug.log

### 4. Email приходит без PDF
**Симптомы:** Письмо пришло, но нет вложения

**Решение:**
- Проверьте sendcontract_debug.log - там должно быть "PDF generated: YES"
- Если пишет "NO" - проверьте что шаблон загружен (test.php)
- Если пишет "Template not found" - загрузите шаблон заново

## Быстрая проверка всей цепочки

1. Откройте https://matrang.com/api/test.php
2. Все зеленое? Идем дальше
3. Откройте админку договоров
4. Загрузите PDF шаблон
5. Обновите test.php - там должен появиться "PDF Шаблон: Найден"
6. Заполните договор с НАСТОЯЩИМ email
7. Отправьте
8. Проверьте sendcontract_debug.log
9. Проверьте почту (и СПАМ!)

## Помощь

Если ничего не помогает:
1. Скопируйте содержимое всех логов с test.php
2. Отправьте мне вместе с описанием что делали
3. Я найду проблему
